name: documentation

on:
  push:
    branches:
      - main
    paths:
      - 'Sources/**/*.swift'
      - .github/workflows/documentation.yml
  workflow_dispatch:

jobs:
  document:
    if: ${{ github.repository == 'compnerd/swift-win32' }}

    runs-on: windows-latest

    strategy:
      matrix:
        include:
          - branch: swift-5.5-branch
            tag: 5.5-DEVELOPMENT-SNAPSHOT-2021-05-02-a
            swift-doc: 1.0.0-rc.1

    steps:
    - uses: actions/checkout@v2
    - uses: seanmiddleditch/gha-setup-vsdevenv@master
    - name: Install Swift
      uses: ./.github/actions/install-swift
      with:
        tag: ${{ matrix.tag }}
        branch: ${{ matrix.branch }}

    - name: Install swift-doc ${{ matrix.swift-doc }}
      run: |
        Install-Binary -Url "https://github.com/SwiftDocOrg/swift-doc/releases/download/${{ matrix.swift-doc }}/swift-doc-${{ matrix.swift-doc }}.msi" -Name "swift-doc-${{ matrix.swift-doc }}.msi" -ArgumentList("-q")
    - name: Adjust Paths
      run: |
        echo "C:\Library\Developer\SwiftDoc\usr\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Prepare
      run: |
        git config user.email "${{ github.actor }}@users.noreply.github.com"
        git config user.name "Swift/Win32"
        git worktree add --no-checkout --detach site
        git -C site remote rm origin
        git -C site remote add origin "https://x-access-token:${{ secrets.PAT }}@github.com/${{ github.repository }}"
        git -C site fetch origin
        git -C site checkout --orphan gh-pages
        git -C site reset --hard
        git -C site read-tree --reset -u origin/website

    - name: Generate Documentation
      run: |
        swift doc generate Sources\SwiftWin32\CG --module-name CoreGraphics --output site\CoreGraphics --base-url https://compnerd.github.io/swift-win32/CoreGraphics
        swift doc generate Sources\SwiftWin32 --module-name SwiftWin32 --output site\SwiftWin32 --base-url https://compnerd.github.io/swift-win32/SwiftWin32
        swift doc generate Sources\SwiftWin32UI --module-name SwiftWin32UI --output site\SwiftWin32UI --base-url https://compnerd.github.io/swift-win32/SwiftWin32UI

    - name: Post-Process
      run: |
        foreach ($module in "CoreGraphics","SwiftWin32","SwiftWin32UI") {
          Get-ChildItem -Path site\$module -Recurse -File -Include "*.md" -Exclude Home.md,_Footer.md,_Sidebar.md,index.md | ForEach-Object {
            Set-Content $_.FullName -value @"
        ---
        layout: default
        title: $($_.BaseName -replace '(?<=\w)_','.')
        parent: $($_.Directory.BaseName)
        ---
        "@,$(Get-Content $_.FullName)
          }
          Set-Content site\$module\Home.md -value @"
        ---
        layout: default
        title: $module
        has_children: true
        ---
        "@,$(Get-Content site\$module\Home.md)
          Move-Item -Path site\$module\Home.md -Destination site\$module\index.md -Force
        }

    - name: Deploy
      run: |
        git -C site add --all
        git -C site commit --quiet --no-verify -m "${{ github.repository }}@${{ github.sha }}"
        git -C site push origin --force HEAD:refs/heads/gh-pages

    - name: Cleanup
      run: |
        git worktree remove --force site
